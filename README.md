# Persian NLP Django Service (Beta)

**نسخه بتا** – تمامی حقوق برای `rakhshai` محفوظ است.

این پروژه یک سرویس ساده برای تحلیل متون فارسی است که با استفاده از
**Django** و **Django REST Framework** پیاده‌سازی شده است. برای پردازش متن
از کتابخانه‌ی **Hazm** جهت نرمال‌سازی و از رویکردهای **سبک و لغت‌محور**
برای تحلیل احساس و تشخیص موجودیت‌های نامدار استفاده شده است. این رویکرد
تکیه‌ای بر مدل‌های سنگین یادگیری عمیق ندارد و در نتیجه امکان اجرا به
صورت کاملاً آفلاین را فراهم می‌کند. همچنین امکان پردازش فایل‌های بزرگ
به‌صورت غیـرهـمگام با **Celery** و **Redis** فراهم شده است.

## ویژگی‌ها

* نرمال‌سازی متن فارسی با [Hazm](https://pypi.org/project/hazm/).
* تحلیل احساس با رویکرد سادهٔ لغت‌محور که بر اساس شمارش واژگان مثبت و
  منفی در متن عمل می‌کند و نیاز به مدل‌های حجیم ندارد.
* تشخیص موجودیت‌های نامدار (NER) با استفاده از واژگان از پیش تعریف‌شده
  شامل نام شخصیت‌های تاریخی، امپراتوری‌ها و مکان‌ها.
* عدم وابستگی به مدل‌های سنگین و امکان اجرای آفلاین.
* پردازش فایل‌های متنی بزرگ در پس‌زمینه با Celery و Redis.

* پاسخ‌گویی به پرسش‌های تاریخی: علاوه بر تحلیل متن، این سرویس یک
  **پایگاه سؤال و جواب** دربارهٔ تاریخ ایران باستان دارد. برای سوالات
  شناخته‌شده، پاسخ از یک فایل داخلی بازیابی می‌شود و در صورت نبود
  پاسخ، سرویس با استفاده از کتابخانه‌های استاندارد مانند
  [`wikipedia`](https://pypi.org/project/wikipedia/) خلاصه‌ای از مقاله‌های
  ویکی‌پدیای فارسی را برمی‌گرداند (نیازمند دسترسی اینترنت). این قابلیت
  تنها روی نرمال‌سازی متن با **Hazm** و مقایسهٔ سادهٔ شباهت بین سؤال‌ها
  تکیه دارد و وابسته به هیچ مدل یادگیری عمیقی نیست.

## راه‌اندازی

این راهنما فرض می‌کند که شما Python 3.10 یا بالاتر و `pip` را نصب کرده‌اید.

1. محیط مجازی بسازید و فعال کنید:

    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```

2. وابستگی‌ها را نصب کنید:

    ```bash
    pip install django djangorestframework hazm celery redis
    # کتابخانه‌های زیر برای پرسش و پاسخ و جستجوی اینترنتی لازم هستند
    pip install wikipedia requests
    ```

3. مخزن را کلون یا کپی کنید و وارد پوشه‌ی پروژه شوید:

    ```bash
    cd persian_nlp_project
    ```

4. مهاجرت‌های پایگاه داده را اعمال کنید و سرور توسعه را اجرا کنید:

    ```bash
    python manage.py migrate
    python manage.py runserver
    ```

5. (اختیاری) اگر قصد دارید فایل‌های بزرگ را به‌صورت غیـرهـمگام پردازش کنید، باید
   Redis را نصب و یک worker Celery اجرا کنید. نمونه‌ی ساده:

    ```bash
    # ترمینال اول
    redis-server

    # ترمینال دوم
    python manage.py migrate
    python manage.py runserver

    # ترمینال سوم
    celery -A mysite worker -l INFO
    ```

## استفاده

### تحلیل متن کوتاه

برای ارسال یک متن کوتاه و دریافت نتیجه‌ی آنی، درخواست POST به مسیر
/api/analyze/ به‌صورت زیر ارسال کنید. به‌عنوان مثال در اینجا
متنی دربارهٔ تاریخ ایران ارسال می‌شود:

```bash
curl -X POST http://127.0.0.1:8000/api/analyze/ \
  -H "Content-Type: application/json" \
  -d '{"text":"کوروش بزرگ بنیان‌گذار امپراتوری هخامنشی بود."}'
```

پاسخ نمونه:

```json
{
  "ok": true,
  "result": {
    "normalized": "کوروش بزرگ بنیان‌گذار امپراتوری هخامنشی بود.",
    "sentiment": {"label": "NEUTRAL", "score": 0.85},
    "entities": [
      {"text": "کوروش بزرگ", "label": "PER", "score": 0.96, "start": 0, "end": 11},
      {"text": "امپراتوری هخامنشی", "label": "ORG", "score": 0.93, "start": 24, "end": 42}
    ]
  }
}

```

### پردازش فایل بزرگ

برای پردازش فایل متنی بزرگ، آن را به‌صورت multipart ارسال کنید. در این
حالت Celery یک job پس‌زمینه ایجاد می‌کند و شناسه‌ی آن را برمی‌گرداند:

```bash
curl -F "file=@/path/to/comments.txt" http://127.0.0.1:8000/api/analyze/
```

خروجی اولیه:

```json
{"ok": true, "job_id": "<celery id>"}
```

برای بررسی وضعیت job:

```bash
curl http://127.0.0.1:8000/api/jobs/<celery id>/
```

اگر job تمام شده باشد، مسیر فایل خروجی و تعداد خطوط پردازش شده برگردانده
می‌شود.

### پرسش و پاسخ دربارهٔ تاریخ ایران باستان

برای طرح یک پرسش تاریخی (مثلاً دربارهٔ کوروش یا هخامنشیان) از مسیر
`/api/answer/` استفاده کنید. بدنهٔ درخواست باید شامل فیلد
`question` (رشتهٔ فارسی) باشد. نمونه:

```bash
curl -X POST http://127.0.0.1:8000/api/answer/ \
  -H "Content-Type: application/json" \
  -d '{"question":"امپراتوری هخامنشی چه زمانی تشکیل شد؟"}'
```

خروجی نمونه:

```json
{
  "ok": true,
  "answer": "امپراتوری هخامنشی در سال ۵۵۰ پیش از میلاد به‌وسیلهٔ کوروش بزرگ تأسیس شد و در سال ۳۳۰ پیش از میلاد با فتح توسط اسکندر مقدونی به پایان رسید."
}
```

این نقطهٔ پایانی صرفاً یک مثال از سوالات موجود در فایل `qa_data.json` است.
اگر سوال شما در این فایل یافت نشود، سرویس با استفاده از کتابخانهٔ
`wikipedia` خلاصه‌ای از مقالهٔ مرتبط در ویکی‌پدیای فارسی را جستجو
می‌کند و به‌عنوان پاسخ باز می‌گرداند. بنابراین لازم است ماشین میزبان
دسترسی به اینترنت داشته باشد تا این بخش به‌درستی عمل کند.

#### افزودن یا ویرایش سوالات

سوال و جواب‌های داخلی در فایل `nlp/qa_data.json` ذخیره شده‌اند. هر
ورودی شامل دو کلید `question` و `answer` است. در صورت نیاز می‌توانید
این فایل را ویرایش و سوالات جدید اضافه کنید. پس از ویرایش، سرور
باید مجدداً راه‌اندازی شود تا تغییرات بارگذاری شوند.

## تغییر مدل یا وظیفه

اگر تمایل دارید نوع تحلیل را عوض کنید (مثلاً خلاصه‌سازی یا طبقه‌بندی
موضوعی)، کافی است منطق مربوطه را در فایل `nlp/pipelines.py` ویرایش کنید.
در نسخه‌ی کنونی، تحلیل احساس و NER به‌صورت لغت‌محور پیاده‌سازی شده‌اند؛
برای تغییر رفتار این توابع می‌توانید واژگان مثبت و منفی را توسعه دهید یا
لیست نام‌ها، مکان‌ها و سازمان‌ها را گسترش دهید. از آنجا که این روش‌ها
وابسته به مدل‌های حجیم نیستند، افزودن یا حذف واژه‌ها به‌سادگی و بدون
نیاز به دانلود مدل‌های جدید امکان‌پذیر است.

## داده‌های نمونه (qa_data.json)

```json
[
  {
    "question": "امپراتوری هخامنشی چه زمانی تشکیل شد و در چه سالی به پایان رسید؟",
    "answer": "امپراتوری هخامنشی در سال ۵۵۰ پیش از میلاد به‌وسیلهٔ کوروش بزرگ تأسیس شد و در سال ۳۳۰ پیش از میلاد با فتح توسط اسکندر مقدونی به پایان رسید  ."
  },
  {
    "question": "کوروش بزرگ که بود و چه دستاوردهایی داشت؟",
    "answer": "کوروش بزرگ (۶۰۰–۵۳۰ پ.م.) بنیان‌گذار امپراتوری هخامنشی بود؛ او با شکست دادن مادها، لیدی و بابِل قلمرو ایران را از آسیای کوچک تا درهٔ سند گسترش داد و بزرگ‌ترین امپراتوری زمان خود را بنیان گذاشت . کوروش به تساهل دینی و آزادسازی یهودیان از اسارت بابلی نیز شهرت دارد ."
  },
  {
    "question": "داریوش بزرگ چه اصلاحاتی در ادارهٔ امپراتوری انجام داد؟",
    "answer": "داریوش یکم پس از رسیدن به پادشاهی، امپراتوری را به حدود ۲۰ ساتراپی تقسیم کرد و برای هر ساتراپ خزانه‌دار، دبیر و فرمانده تعیین نمود تا قدرت میان چند مقام توزیع شود . او همچنین شبکهٔ جاده‌ها و ایستگاه‌های شاهی را گسترش داد، کانال‌های آبی و ناوگان دریایی ساخت و سفر رسمی را با مجوز و تأمین آذوقه ممکن کرد ."
  },
  {
    "question": "نبرد ماراتون چه زمانی رخ داد و نتیجهٔ آن چه بود؟",
    "answer": "نبرد ماراتون در سال ۴۹۰ پ.م. هنگام نخستین یورش ایران به یونان روی داد و میان شهروندان آتن و پلاتئا از یک سو و سپاه پارس به فرماندهی داتیس و آرتافرنس از سوی دیگر بود. ارتش یونان با وجود شمار کمتر پیروزی قاطعانه‌ای به دست آورد و این شکست برای ایرانیان نقطهٔ عطفی در جنگ‌های ایرانی–یونانی به شمار می‌رود ."
  },
  {
    "question": "امپراتوری هخامنشی چگونه پایان یافت؟",
    "answer": "امپراتوری هخامنشی در سال ۳۳۰ پیش از میلاد، هنگامی که اسکندر مقدونی ایران را فتح کرد، فروپاشید. فتح اسکندر پایان این امپراتوری و آغاز دورهٔ هلنیستی در منطقه بود ."
  },
  {
    "question": "گسترهٔ جغرافیایی امپراتوری هخامنشی چه اندازه بود و چه مناطقی را در بر می‌گرفت؟",
    "answer": "امپراتوری هخامنشی در اوج قدرت خود مساحتی حدود ۵٫۵ میلیون کیلومتر مربع داشت و از بالکان و مصر در غرب تا بیشتر آسیای غربی، بخش اعظم آسیای میانه و درهٔ سند در جنوب شرق کشیده شده بود ."
  },
  {
    "question": "داریوش چه پروژه‌های عمرانی مهمی را به اجرا گذاشت؟",
    "answer": "داریوش در کنار اصلاحات اداری، پروژه‌های بزرگ عمرانی را نیز آغاز کرد. او کاخ‌های سلطنتی جدیدی در شوش و تخت جمشید بنا کرد و برای بهبود بازرگانی کانالی ساخت که رود نیل را به دریای سرخ متصل می‌کرد و راه شاهی را توسعه داد ."
  }
]
```

## توجه حقوقی

این پروژه تحت نسخه‌ی بتا ارائه می‌شود و **تمام حقوق مادی و معنوی متعلق به
`rakhshai`** می‌باشد. استفاده از این پروژه تنها برای اهداف آموزشی و
تحقیقاتی مجاز است.
